name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  validate-branch:
    name: Validate Branch Naming
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ "$BRANCH_NAME" != feature/* && "$BRANCH_NAME" != hotfix/* ]]; then
            echo "❌ Branch name must start with 'feature/' or 'hotfix/'"
            exit 1
          fi
          echo "✅ Branch name is valid: $BRANCH_NAME"

          
  check-issue-link:
    name: Check Issue Link
    runs-on: ubuntu-latest
    steps:
      - name: Ensure PR description links to an issue
        run: |
          BODY="${{ github.event.pull_request.body }}"
          if [[ "$BODY" != *"Closes #"* && "$BODY" != *"Fixes #"* && "$BODY" != *"Resolves #"* ]]; then
            echo "❌ Pull request must link to an issue using 'Closes #', 'Fixes #', or 'Resolves #'"
            exit 1
          fi
          echo "✅ Issue link found in PR description"

  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install flake8
        run: pip install flake8
      - name: Lint backend
        run: flake8 Back-End/etl/
      - name: Lint dashboard
        run: flake8 Dashboard/

  test-etl:
    name: Test ETL Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: pip install -r Dashboard/requirements.txt
      - name: Run ETL tests
        run: pytest Back-End/etl/tests

  validate-sql:
    name: Validate SQL Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check SQL files
        run: |
          for file in Back-End/sql/*.sql; do
            echo "Validating $file"
            sqlite3 :memory: < "$file" || echo "Syntax error in $file"
          done
